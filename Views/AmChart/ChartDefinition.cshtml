@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .chart-themes {
        padding-left: 0px;
    }

    .chart-themes li{
        display: inline-block;
    }

    .chart-themes li a{
        border-radius: 4px !important;
    }

    .chart-themes li.active a{
        border: 2px solid #72acd9;
    }

    .chart-themes li a:hover{
        border: 2px solid #72acd9;   
    }

    .theme-default a{
        background-position: 0 0;
    }

        .theme-default.active a, .theme-default a:hover{
            background-position: -2px -2px
        }

    .theme-patterns a{
        background-position: -32px 0;
    }

        .theme-patterns.active a, .theme-patterns a:hover{
            background-position: -34px -2px;
        }

    .theme-chalk a{
        background-position: -64px -0px;
    }

        .theme-chalk.active a, .theme-chalk a:hover{
            background-position: -66px -2px;
        }

    .theme-dark a{
       background-position: -96px 0;
    }

        .theme-dark.active a, .theme-dark a:hover{
            background-position: -98px -2px;
        }

    .theme-light a{
        background-position: -128px 0;
    }

        .theme-light.active a, .theme-light a:hover{
            background-position: -130px -2px;
        }

    .theme-black a{
        background-position: -158px 0;
    }

        .theme-black.active a, .theme-black a:hover{
            background-position: -160px -2px;
        }


    .chart-themes a{
        background-image: url(@Url.Content("~/content/img/amchart/themes.png"));
        background-repeat: no-repeat;
        width: 25px;
        height: 25px;
        margin: 0;
        padding: 0;
        display: block;
    }
</style>

<input type="hidden" id="chartDefinition" value=""/>

<div>
    <ul class="nav nav-tabs">
        <li class="active">
            <a href="#tabSerie" data-toggle="tab">Gráfico</a>
        </li>
        <li>
            <a href="#tabDefinicao" data-toggle="tab">Avançado (JSON)</a>
        </li>
    </ul>
    <div class="tab-content">
        <div class="tab-pane active" id="tabSerie">
            <div class="form">
                <div class="form-group">
                    <label class="control-label">
                        <div class="label-form">
                            <div class="label-title">Tema</div>
                        </div>
                    </label>
                    <div>
                        <ul class="chart-themes">
                            <li class="theme-default"><a class="default"></a></li>
                            <li class="theme-patterns"><a class="patterns"></a></li>
                            <li class="theme-chalk"><a class="chalk"></a></li>
                            <li class="theme-dark"><a class="dark"></a></li>
                            <li class="theme-light"><a class="light"></a></li>
                            <li class="theme-black"><a class="black"></a></li>
                        </ul>
                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label">
                        <div class="label-form">
                            <div class="label-title">Categoria</div>
                        </div>
                    </label>
                    <div>
                        <select class="form-control" id="category">
                            @foreach (var field in ViewBag.Fields)
                            {
                                <option value="@field.Name">@field.Name</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label">
                        <div class="label-form">
                            <div class="label-title">Legenda do eixo principal</div>
                        </div>
                    </label>
                    <div>
                        <input type="text" id="legendaEixo" class="form-control" />
                    </div>
                </div>
                <div class="form-group">
                	<div class="mt-checkbox-list">
                		<label class="mt-checkbox mt-checkbox-outline">
                			<input type="checkbox" id="empilharSeries"/> Empilhar séries
                			<span></span>
                		</label>
                        <label class="mt-checkbox mt-checkbox-outline">
                            <input type="checkbox" id="grafico3D"/> Gráfico 3D
                            <span></span>
                        </label>
                	</div>
                </div>
            </div>
        </div>
        <div class="tab-pane" id="tabDefinicao">
            <div class="note note-info">
                <p>Veja a <a href="https://docs.amcharts.com/3/javascriptcharts/AmChart" target="_blank">documentação</a> do AmCharts e confira todas as possibilidades de customização para o seu gráfico.</p>
            </div>
        	<div id="editor" style="height:280px">
				
			</div>
        </div>
    </div>
</div>



@section scripts
{
	<script src="@Url.Content("~/content/js/ace/ace.js")"></script>

	<script>
		var chartDefinition;
		var jsonChartDefinition = '@ViewBag.Definition';
        var editor = ace.edit('editor');


		function updateChartDefinition(){
			$('#chartDefinition').val(btoa(JSON.stringify(chartDefinition)));
		}

		$(function(){
			if(jsonChartDefinition != ''){
				chartDefinition = JSON.parse(jsonChartDefinition.replace(/&quot;/g, '"'));
                updateChartDefinition();
                $('#category').val(chartDefinition.categoryField.toUpperCase());
			}

            $('#category').on('change', function(){
                chartDefinition.categoryField = $(this).val();
                updateChartDefinition();
            });

            $('#empilharSeries').on('change', function(){
                if(document.getElementById('empilharSeries').checked == true){
                    chartDefinition.valueAxes[0].stackType = 'regular';
                }
                else {
                    delete chartDefinition.valueAxes[0].stackType;
                }

                updateChartDefinition();
            });

            if(chartDefinition.theme){
                $('a.'+chartDefinition.theme).closest('li').addClass('active');
            } else {
                $('a.default').closest('li').addClass('active');
            }

            $('.chart-themes a').on('click', function(){
                $('.chart-themes li').removeClass('active');
                $(this).closest('li').addClass('active');
                chartDefinition.theme = $(this).attr('class');
                updateChartDefinition();
            });

            $('#grafico3D').on('change', function(){
                if(document.getElementById('grafico3D').checked == true){
                    chartDefinition.angle = 30;
                    chartDefinition.depth3D = 30;
                } else {
                    chartDefinition.angle = 0;
                    chartDefinition.depth3D = 0;
                }
                updateChartDefinition();
            });

            if(chartDefinition.depth3D > 0){
                document.getElementById('grafico3D').checked = true;
            }

            if(chartDefinition.valueAxes[0].stackType){
                document.getElementById('empilharSeries').checked = true;
            }

            if(chartDefinition.valueAxes[0].title){
                document.getElementById('legendaEixo').value = chartDefinition.valueAxes[0].title;
            }

            $('#legendaEixo').on('blur', function(){
                chartDefinition.valueAxes[0].title = $(this).val();
                updateChartDefinition();
            });

            editor.on('blur', function () {
                chartDefinition = JSON.parse(editor.getSession().getValue());
                updateChartDefinition();
            });

            $('a[data-toggle="tab"]').on('shown.bs.tab', function (evt) {
                var tab = $(evt.target).attr('href');
                if (tab == '#tabDefinicao') {
                    editor.getSession().setValue(JSON.stringify(chartDefinition, null, '\t'), 1);
                    editor.resize();
                } else if (tab == '#tabSerie') {
                    $('#category').val(chartDefinition.categoryField.toUpperCase());

                    if(chartDefinition.valueAxes[0].title)
                        $('#legendaEixo').val(chartDefinition.valueAxes[0].title);

                    $('.chart-themes li').removeClass('active');
                    $('.'+chartDefinition.theme).closest('li').addClass('active');

                    if(chartDefinition.depth3D > 0){
                        document.getElementById('grafico3D').checked = true;
                    }

                    if(chartDefinition.valueAxes[0].stackType){
                        document.getElementById('empilharSeries').checked = true;
                    }
                }
            });
            

            editor.getSession().setMode('ace/mode/javascript');
            editor.getSession().setValue(JSON.stringify(chartDefinition, null, '\t'));
		});
	</script>
}
