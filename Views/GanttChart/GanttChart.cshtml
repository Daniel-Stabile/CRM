@using Benner.Corporativo.DataContracts.GestaoProjetos
@model ProjetoResponse

@{
    var dados = Model;
    Ajax.OnReadyScript("ProcessarGrafico()");
}

<!-- Styles -->
<style>
    #chartdiv {
        width: 100%;
        min-height: 400px;
        max-height: 700px;
    }
</style>

<!-- Resources -->
<script src="https://cdn.amcharts.com/lib/4/core.js"></script>
<script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
<script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
<script src="https://www.amcharts.com/lib/4/lang/pt_BR.js"></script>


<input hidden value="@dados.DadosGrafico" id="dadosGrafico" />
<input hidden value="@ViewBag.TipoFiltro" id="tipoFiltro" />

<!-- Chart code -->
<script>

    var GerarGrafico = function () {

        am4core.disposeAllCharts();

        am4core.ready(function () {
            am4core.useTheme(am4themes_animated);

            var chart = am4core.create("chartdiv", am4charts.XYChart);
            chart.hiddenState.properties.opacity = 0;

            chart.language.locale = am4lang_pt_BR;
            chart.dateFormatter.language = new am4core.Language();
            chart.dateFormatter.language.locale = am4lang_pt_BR;

            chart.paddingRight = 30;
            chart.dateFormatter.inputDateFormat = "dd/MM/yyyy HH:mm";

            var jsonChartDefinition = document.getElementById('dadosGrafico').value;

            if (jsonChartDefinition != "") {
                chart.data = JSON.parse(jsonChartDefinition);
                chart.scrollbarX = new am4core.Scrollbar();

                chart.scrollbarY = new am4core.Scrollbar();
                chart.scrollbarY.start = 1;
                chart.scrollbarY.end = chart.data.length < 100 ? 0.3 : 0.6;

                let legend = new am4charts.Legend();
                legend.parent = chart.chartContainer;
                legend.align = "bottom";

                if (document.getElementById('tipoFiltro').value == 2){
                    legend.data = [{
                        "name": "Projeto",
                        "fill": "#0a3560"
                    }, {
                        "name": "Agrupadora",
                        "fill": "#1672cf"
                    }, {
                        "name": "Tarefa",
                        "fill": "#95c3f3"
                    }, {
                        "name": "Apontamento realizado",
                        "fill": "#000000"
                    },
                    {
                        "name": "Linha de Base",
                        "fill": "#7f7f7f"                        
                    }];
                }
                else{
                    legend.data = [{
                        "name": "Projeto",
                        "fill": "#0a3560"
                    }, {
                        "name": "Agrupadora",
                        "fill": "#1672cf"
                    }, {
                        "name": "Tarefa",
                        "fill": "#95c3f3"
                    },
                    {
                        "name": "Linha de Base",
                        "fill": "#7f7f7f"                        
                    }];
                }
            }

            chart.dateFormatter.dateFormat = "dd/MM/yyyy";
            chart.dateFormatter.inputDateFormat = "dd/MM/yyyy";

            var categoryAxis = chart.yAxes.push(new am4charts.CategoryAxis());
            categoryAxis.dataFields.category = "Tarefa";
            categoryAxis.renderer.grid.template.location = 0;
            categoryAxis.renderer.inversed = true;
            categoryAxis.renderer.minGridDistance = 25;

            var dateAxis = chart.xAxes.push(new am4charts.DateAxis());
            dateAxis.renderer.minGridDistance = 70;
            dateAxis.baseInterval = { count: 1, timeUnit: "day" };
            dateAxis.renderer.tooltipLocation = 0;

            var series1 = chart.series.push(new am4charts.ColumnSeries());
            series1.columns.template.height = am4core.percent(70);
            series1.columns.template.tooltipText = "{Descricao}";
            series1.clustered = false;

            series1.dataFields.openDateX = "DataInicial";
            series1.dataFields.dateX = "DataFinal";
            series1.dataFields.categoryY = "Tarefa";
            series1.columns.template.propertyFields.fill = "Cor";
            series1.columns.template.propertyFields.stroke = "Cor";
            series1.columns.template.strokeOpacity = 1;
            series1.columns.template.propertyFields.url = "UrlTarefa";
            
            var altura = 0;

            if (document.getElementById('tipoFiltro').value == 2 && "DataInicialApontamento" != null)
            {
                altura = am4core.percent(40);

                var series2 = chart.series.push(new am4charts.ColumnSeries());
                series2.columns.template.height = altura;
                series2.clustered = true;

                var percentual = "{PercentualConclusao}";
                series2.columns.template.tooltipText = percentual + "%";

                series2.dataFields.openDateX = "DataInicialApontamento";
                series2.dataFields.dateX = "DataFinalApontamento";
                series2.dataFields.categoryY = "Tarefa";
                series2.columns.template.propertyFields.fill = "CorRealizado";
                series2.columns.template.propertyFields.stroke = "CorRealizado";
                series2.columns.template.strokeOpacity = 1;
            }
            else
            {
                altura = am4core.percent(20);
            }
            
            if ("DataInicioLinhaBase" != null)
            {
                var series3 = chart.series.push(new am4charts.ColumnSeries());
                series3.columns.template.height = altura;
                series3.clustered = true;
                series3.dataFields.openDateX = "DataInicioLinhaBase";
                series3.dataFields.dateX = "DataFinalLinhaBase";
                series3.dataFields.categoryY = "Tarefa";
                series3.columns.template.propertyFields.fill = "CorLinhaBase";
                series3.columns.template.propertyFields.stroke = "CorLinhaBase";
                series3.columns.template.strokeOpacity = 1;  
            }

            var cellSize = 40;
            chart.events.on("datavalidated", function (ev) {

                var chart = ev.target;
                var categoryAxis = chart.yAxes.getIndex(0);

                var adjustHeight = chart.data.length * cellSize - categoryAxis.pixelHeight;

                var targetHeight = chart.pixelHeight + adjustHeight;

                chart.svgContainer.htmlElement.style.height = targetHeight + "px";
            });
        });
    };

    var ProcessarGrafico = function () {

        GerarGrafico();
    };

</script>

<!-- HTML -->
<div id="chartdiv"></div>