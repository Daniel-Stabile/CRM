@using Benner.Corporativo.DataContracts.GestaoProjetos
@model MetaIndicadorResponse

@{
    var dados = Model;
}


<style>
  #chartdiv {
  width: 100%;
  height: 500px;
  }
</style>

<script src="https://cdn.amcharts.com/lib/4/core.js"></script>
<script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
<script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>


<script>
  am4core.ready(function() {

    am4core.useTheme(am4themes_animated);

    var chart = am4core.create("chartdiv", am4charts.XYChart);
    chart.scrollbarX = new am4core.Scrollbar();

    var chartData = [];

    @{
      foreach (var pontoControle in dados.PontoControle)
      {
        @:var dataPoint = {};
        @:dataPoint["nomePontoControle"] = "@pontoControle.NomePontoControle";
        @:dataPoint["metaPontoControle"] = @pontoControle.MetaPontoControle;
        @:dataPoint["medicaoPontoControle"] = @pontoControle.MedicaoPontoControle;
        @:dataPoint["valorInicialPontoControle"] = @pontoControle.ValorInicialPontoControle;
        @:dataPoint["desempenhoPontoControle"] = @pontoControle.DesempenhoPontoControle; 
        @:chartData.push(dataPoint);
      }

    }

    var totalDataPoint = {};
    totalDataPoint["nomePontoControle"] = "Acumulado";
    totalDataPoint["metaPontoControle"] = @dados.MetaIndicador;
    totalDataPoint["medicaoPontoControle"] = @dados.MetIndicadorTotal;
    totalDataPoint["valorInicialPontoControle"] = @dados.ValorInicialIndicador;
    totalDataPoint["desempenhoPontoControle"] = @dados.DesempenhoIndicador; 
    chartData.push(totalDataPoint); 

    chart.data = chartData;
    prepareParetoData();

    function prepareParetoData() {
      var total = 0;
      var maxDesempenho = 0;

      for (var i = 0; i < chart.data.length; i++) {
        var value = chart.data[i].metaPontoControle;
        total += value;

        var desempenho = chart.data[i].desempenhoPontoControle;
        if (desempenho > maxDesempenho) {
          maxDesempenho = desempenho;
        }
      }

      var sum = 0;
      for (var i = 0; i < chart.data.length; i++) {
        var value = chart.data[i].metaPontoControle;
        sum += value;

        var desempenho = chart.data[i].desempenhoPontoControle;
        if (maxDesempenho > 0) {
          chart.data[i].pareto = desempenho;
        } else {
          chart.data[i].pareto = 0;
        }
      }
    }

    var legend = new am4charts.Legend();
    chart.legend = legend;
    legend.align = "center";
    legend.position = "bottom";

    var categoryAxis = chart.xAxes.push(new am4charts.CategoryAxis());
    categoryAxis.dataFields.category = "nomePontoControle";
    categoryAxis.renderer.grid.template.location = 0;
    categoryAxis.renderer.minGridDistance = 60;
    categoryAxis.tooltip.disabled = true;
    categoryAxis.renderer.grid.template.disabled = true;
    categoryAxis.renderer.cellEndLocation = 0.8;

    var valueAxis = chart.yAxes.push(new am4charts.ValueAxis());
    valueAxis.renderer.minWidth = 50;
    valueAxis.min = 0;
    valueAxis.cursorTooltipEnabled = false;

    var series = chart.series.push(new am4charts.ColumnSeries());
    series.sequencedInterpolation = true;
    series.dataFields.valueY = "metaPontoControle";
    series.dataFields.categoryX = "nomePontoControle";
    series.name = "Meta";
    series.tooltipText = "[{categoryX}: bold]{valueY}[/]";
    series.columns.template.strokeWidth = 0;
    series.columns.template.fill = am4core.color("#00BFFF");

    series.tooltip.pointerOrientation = "vertical";

    series.columns.template.column.cornerRadiusTopLeft = 10;
    series.columns.template.column.cornerRadiusTopRight = 10;
    series.columns.template.column.fillOpacity = 0.8;

    var hoverState = series.columns.template.column.states.create("hover");
    hoverState.properties.cornerRadiusTopLeft = 10;
    hoverState.properties.cornerRadiusTopRight = 10;
    hoverState.properties.fillOpacity = 1;

    var seriesMedicao = chart.series.push(new am4charts.ColumnSeries());
    seriesMedicao.dataFields.valueY = "medicaoPontoControle";
    seriesMedicao.dataFields.categoryX = "nomePontoControle";
    seriesMedicao.name = "Medi\u00E7\u00E3o";
    seriesMedicao.tooltipText = "[{categoryX}: bold]{valueY}[/]";
    seriesMedicao.columns.template.strokeWidth = 0;
    seriesMedicao.columns.template.fill = am4core.color("#C0C0C0");

    seriesMedicao.tooltip.pointerOrientation = "vertical";

    seriesMedicao.columns.template.column.cornerRadiusTopLeft = 10;
    seriesMedicao.columns.template.column.cornerRadiusTopRight = 10;
    seriesMedicao.columns.template.column.fillOpacity = 0.8;

    var hoverStateMedicao = seriesMedicao.columns.template.column.states.create("hover");
    hoverStateMedicao.properties.cornerRadiusTopLeft = 10;
    hoverStateMedicao.properties.cornerRadiusTopRight = 10;
    hoverStateMedicao.properties.fillOpacity = 1;

    var seriesValorInicial = chart.series.push(new am4charts.ColumnSeries());
    seriesValorInicial.dataFields.valueY = "valorInicialPontoControle";
    seriesValorInicial.dataFields.categoryX = "nomePontoControle";
    seriesValorInicial.name = "Valor Inicial";
    seriesValorInicial.tooltipText = "[{categoryX}: bold]{valueY}[/]";
    seriesValorInicial.columns.template.strokeWidth = 0;
    seriesValorInicial.columns.template.fill = am4core.color("#FF7F50");

    seriesValorInicial.tooltip.pointerOrientation = "vertical";

    seriesValorInicial.columns.template.column.cornerRadiusTopLeft = 10;
    seriesValorInicial.columns.template.column.cornerRadiusTopRight = 10;
    seriesValorInicial.columns.template.column.fillOpacity = 0.8;

    var hoverStateValorInicial = seriesValorInicial.columns.template.column.states.create("hover");
    hoverStateValorInicial.properties.cornerRadiusTopLeft = 10;
    hoverStateValorInicial.properties.cornerRadiusTopRight = 10;
    hoverStateValorInicial.properties.fillOpacity = 1;

    var paretoValueAxis = chart.yAxes.push(new am4charts.ValueAxis());
    paretoValueAxis.renderer.opposite = true;
    paretoValueAxis.min = 0;

    @{
      @:var desempenhoString = '@dados.DesempenhoIndicador';
      @:var desempenho = parseFloat(desempenhoString.replace(',', '.'));
    }


    if(desempenho > 120.00)
    {
      paretoValueAxis.max = @dados.DesempenhoIndicador;
    }
    else
    {
      paretoValueAxis.max = 120,00;
    }

    paretoValueAxis.strictMinMax = true;
    paretoValueAxis.renderer.grid.template.disabled = true;
    paretoValueAxis.numberFormatter = new am4core.NumberFormatter();
    paretoValueAxis.numberFormatter.numberFormat = "#'%'"
    paretoValueAxis.cursorTooltipEnabled = false;

    var paretoSeries = chart.series.push(new am4charts.LineSeries())
    paretoSeries.dataFields.valueY = "pareto";
    paretoSeries.dataFields.categoryX = "nomePontoControle";
    paretoSeries.yAxis = paretoValueAxis;
    paretoSeries.name = "Desempenho";
    paretoSeries.tooltipText = "Desempenho: {valueY.formatNumber('#.0')}%[/]";
    paretoSeries.bullets.push(new am4charts.CircleBullet());
    paretoSeries.strokeWidth = 2;
    paretoSeries.stroke = new am4core.InterfaceColorSet().getFor("alternativeBackground");
    paretoSeries.strokeOpacity = 0.5;
    paretoSeries.fill = am4core.color("#DAA520");

    chart.cursor = new am4charts.XYCursor();
    chart.cursor.behavior = "panX";

  });
</script>

<div class="divUM">Unidade medi&ccedil;&atilde;o: @dados.UnidadeMedicaoIndicador</div>

<table>
  <tr>
    <td class="campo">Pontos de Controle</td>
    <td class="campo">Meta</td>
    <td class="campo">Valor Inicial</td>
    <td class="campo">Medi&ccedil;&atilde;o</td>
    <td class="campo">Desempenho</td>
  </tr>

  @{
    foreach (var pontoControle in dados.PontoControle)
    {
      <tr>
        <td>@pontoControle.NomePontoControle</td>
        <td>@string.Format("{0:N2}", @pontoControle.MetaPontoControle)</td>
        <td>@string.Format("{0:N2}", @pontoControle.ValorInicialPontoControle)</td>
        <td>@string.Format("{0:N2}", @pontoControle.MedicaoPontoControle)</td>
        <td>@pontoControle.DesempenhoPontoControle%</td>
      </tr>
    }
  }

  <tr>
    <td class="campoAcumulado">Acumulado</td>
    <td class="campoAcumulado">@string.Format("{0:N2}", @dados.MetaIndicador)</td>
    <td class="campoAcumulado">@string.Format("{0:N2}", @dados.ValorInicialIndicador)</td>
    <td class="campoAcumulado">@string.Format("{0:N2}", @dados.MetIndicadorTotal)</td>
    <td class="campoAcumulado">@dados.DesempenhoIndicador%</td>
  </tr>

  <tr>
    <td class="tituloAnalise">An&aacute;lise Cr&iacute;tica</td>
    <td class="Analise" colspan="4">@dados.AnaliseCritica</td>
  </tr>

</table>

<div id="chartdiv" class="divChart"></div>

<style>

  .divUM {
    font-size: large;
    position: relative;
    display: flex;
    padding: 10px 0;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  td {
    padding: 10px;
    text-align: center;
    border: 1px solid #ccc;
  }

  .campo {
    font-weight: bold;
  }

  .campoAcumulado {
    font-weight: bold;
    background-color: #f0f0f0;
  }

  td:empty {
    background-color: #f0f0f0;
  }

  td.campo:nth-child(2), td:nth-child(4) {
    width: 20%;
  }

.tituloAnalise {
    font-weight: bold;
    height: 10rem;
}

.Analise {
    text-align: left;
    min-width: 10rem;
    padding-right: 1rem;
    vertical-align: top;
}

</style>