<?xml version="1.0"?>
<ScriptPortable xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <ViewName>K_CRM_PESSOAOPORTUNIDADESITENS.NOVAOPORTUNIDADE.GRID</ViewName>
  <EntityName>K_CRM_PESSOAOPORTUNIDADESITENS</EntityName>
  <Level>Cliente</Level>
  <Scripts>
    <ScriptItemPortable>
      <FunctionName>InitializeRow</FunctionName>
      <LanguageName>IronPython</LanguageName>
      <SourceCode>def InitializeRow(entity, row):
    from Benner.Tecnologia.Common import EntityBase
    from Benner.Tecnologia.Common import EntityDefinition
    from Benner.Tecnologia.Common import Entity
    from Benner.Tecnologia.Common import Criteria
    from Benner.Tecnologia.Common import Parameter
    from Benner.Tecnologia.Common import BennerIdentity
    from Benner.Tecnologia.Common import QuerySource

    if entity.Fields["HANDLE"].IsValid():
        oportunidade = entity.Fields["OPORTUNIDADE"];
        versao = entity.Fields["VERSAO"];
        criterio = Criteria()
        sql = "SELECT TOP 1 * FROM K_CRM_PO_DESCONTOS A WHERE A.OPORTUNIDADE = :OPORTUNIDADE AND A.VERSAO = :VERSAO AND A.NIVELAPROVACAO &gt;= 1 AND A.NIVELAPROVACAO &lt;= 5 AND A.DATAAPROVACAO &gt;= (SELECT MAX(DATAAPROVACAO) FROM K_CRM_PO_DESCONTOS AS D2 WHERE A.OPORTUNIDADE = D2.OPORTUNIDADE AND A.VERSAO = D2.VERSAO AND D2.NIVELAPROVACAO = 1) ORDER BY NIVELAPROVACAO DESC";
        criterio.Parameters.Add(Parameter("OPORTUNIDADE", oportunidade.Handle));
        criterio.Parameters.Add(Parameter("VERSAO", versao));
        ed = EntityDefinition.Create();
        ed.EntitySource = QuerySource(sql);
        desconto = Entity.GetFirstOrDefault(ed, criterio);
        
        opInstance = Entity.Get(EntityDefinition.GetByName("K_CRM_PESSOAOPORTUNIDADES"), oportunidade.Handle);
        
        if opInstance.Ativo == True:
            row.EditCommand.Visible = False;
            row.DeleteCommand.Visible = False;

        if None != desconto and desconto.Fields["STATUS"] in [3]:
            if None != row.GetCustomCommand("cmdEditCustom"):
                row.GetCustomCommand("cmdEditCustom").Enabled = False;
            if None != row.DeleteCommandand and None != row.EditCommand:
                row.EditCommand.Visible = False
                row.DeleteCommand.Visible = False;
                    
        crit3 = Criteria("A.OPORTUNIDADE IN (:OPORTUNIDADE) AND A.VERSAO = :VERSAO AND A.TIPO = 2");       
        crit3.Parameters.Add(Parameter("OPORTUNIDADE", oportunidade));
        crit3.Parameters.Add(Parameter("VERSAO", versao));
        proposta = Entity.GetMany(EntityDefinition.GetByName("K_CRM_PO_PROPOSTA"), crit3);
        if None != proposta:
            if proposta.Count &gt; 0:
                if None != row.GetCustomCommand("cmdEditCustom"):
                    row.GetCustomCommand("cmdEditCustom").Enabled = False;
                if None != row.DeleteCommand and None != row.EditCommand:
                    row.EditCommand.Visible = False;
                    row.DeleteCommand.Visible = False;
                
        #tipo = entity.Mercadoria.Instance.Item.Instance.Tipo.Instance;#entity.Fields["MERCADORIA"].Instance.Fields["ITEM"].Instance.Fields["TIPO"];    
        crit2 = Criteria("A.HANDLE IN (SELECT TIPO FROM K_CRM_PRODUTOITENS WHERE HANDLE IN (SELECT ITEM FROM K_CRM_TABELASPRECOITENS WHERE HANDLE = :MERCADORIA))");
        crit2.Parameters.Add(Parameter("MERCADORIA", entity.Fields["MERCADORIA"].Handle));
        tipo = Entity.GetFirstOrDefault(EntityDefinition.GetByName("K_CRM_PRODUTOITENSTIPO"), crit2);
        if None != tipo:
            if None != row.GetCustomCommand("CmdVerItensPacote"):
                if tipo.Fields["NOME"] != "Pacote":
                    row.GetCustomCommand("CmdVerItensPacote").Enabled = False;
</SourceCode>
    </ScriptItemPortable>
    <ScriptItemPortable>
      <FunctionName>Load</FunctionName>
      <LanguageName>IronPython</LanguageName>
      <SourceCode>def Load(widget):
    from System.Threading import Thread
    from Benner.Tecnologia.Common import EntityBase
    from Benner.Tecnologia.Common import EntityDefinition
    from Benner.Tecnologia.Common import Entity
    from Benner.Tecnologia.Common import Criteria
    from Benner.Tecnologia.Common import Parameter
    from Benner.Tecnologia.Common import BennerIdentity
    from Benner.Tecnologia.Common import QuerySource

    entity = widget.ProviderWidget.ProviderWidget.Entity
    
    if entity.Fields["HANDLE"].IsValid():
        oportunidade = entity.Fields["HANDLE"];
        versao = entity.Fields["VERSAO"];
        criteria = Criteria("A.HANDLE IN (SELECT MODALIDADE FROM K_CRM_PESSOAOPORTUNIDADES WHERE HANDLE = :OPORTUNIDADE)", Parameter("OPORTUNIDADE", oportunidade));
        modalidade = Entity.Get(EntityDefinition.GetByName("K_CRM_MODALIDADES"), criteria);
        
        if entity.Ativo == True:
            widget.View.Commands["New"].Visible = False;
        
        criterio = Criteria()
        sql = "SELECT TOP 1 * FROM K_CRM_PO_DESCONTOS A WHERE A.OPORTUNIDADE = :OPORTUNIDADE AND A.VERSAO = :VERSAO AND A.NIVELAPROVACAO &gt;= 1 AND A.NIVELAPROVACAO &lt;= 5 AND A.DATAAPROVACAO &gt;= (SELECT MAX(DATAAPROVACAO) FROM K_CRM_PO_DESCONTOS AS D2 WHERE A.OPORTUNIDADE = D2.OPORTUNIDADE AND A.VERSAO = D2.VERSAO AND D2.NIVELAPROVACAO = 1) ORDER BY NIVELAPROVACAO DESC";
        criterio.Parameters.Add(Parameter("OPORTUNIDADE", oportunidade));
        criterio.Parameters.Add(Parameter("VERSAO", versao));
        ed = EntityDefinition.Create();
        ed.EntitySource = QuerySource(sql);
        desconto = Entity.GetFirstOrDefault(ed, criterio);
        if None != desconto and desconto.Fields["STATUS"] in [3]:
            widget.View.Commands["cmdNewCustom"].Visible = False;
            widget.View.Commands["New"].Visible = False;
            
        crit3 = Criteria("A.OPORTUNIDADE IN (:OPORTUNIDADE) AND A.VERSAO = :VERSAO AND A.TIPO = 2");       
        crit3.Parameters.Add(Parameter("OPORTUNIDADE", oportunidade));
        crit3.Parameters.Add(Parameter("VERSAO", versao));
        proposta = Entity.GetMany(EntityDefinition.GetByName("K_CRM_PO_PROPOSTA"), crit3);
        if None != proposta:
            if proposta.Count &gt; 0:
                if None != widget.View.Commands["cmdNewCustom"]:
                    widget.View.Commands["cmdNewCustom"].Visible = False;
</SourceCode>
    </ScriptItemPortable>
  </Scripts>
</ScriptPortable>