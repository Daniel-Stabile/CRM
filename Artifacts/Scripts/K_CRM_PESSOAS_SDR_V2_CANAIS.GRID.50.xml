<?xml version="1.0"?>
<ScriptPortable xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <ViewName>K_CRM_PESSOAS_SDR_V2_CANAIS.GRID</ViewName>
  <EntityName>K_CRM_PESSOAS</EntityName>
  <Level>Cliente</Level>
  <Scripts>
    <ScriptItemPortable>
      <FunctionName>Load</FunctionName>
      <LanguageName>IronPython</LanguageName>
      <SourceCode>def Load(widget):
    from System.Threading import Thread
    from Benner.Tecnologia.Common import EntityBase
    from Benner.Tecnologia.Common import Entities
    from Benner.Tecnologia.Common import EntityDefinition
    from Benner.Tecnologia.Common import EntityState
    from Benner.Tecnologia.Common import Entity
    from Benner.Tecnologia.Common import Criteria
    from Benner.Tecnologia.Common import Parameter
    from Benner.Tecnologia.Common import GetMode
    from Benner.Tecnologia.Common import ListItem
    from Benner.Tecnologia.Common import EntityAssociation
    from Benner.Tecnologia.Common import BennerContext
    
    #ehExecutivo = Thread.CurrentPrincipal.IsInRole("K_CRM_EXECUTIVO_CONTAS")
    ehArquiteto = Thread.CurrentPrincipal.IsInRole("K_CRM_ARQUITETO_SOLUCOES")
    ehGestorComercial = Thread.CurrentPrincipal.IsInRole("K_CRM_GESTOR_COMERCIAL")
    ehGestorComercialRevenda = Thread.CurrentPrincipal.IsInRole("K_CRM_GESTOR_COMERCIAL_REVENDA")
    ehGestorProduto = Thread.CurrentPrincipal.IsInRole("K_CRM_GESTOR_PRODUTO") 
    ehPresidente = Thread.CurrentPrincipal.IsInRole("K_CRM_PRESIDENTE")
    ehVicePresidente = Thread.CurrentPrincipal.IsInRole("K_CRM_VP")
    ehDiretor = Thread.CurrentPrincipal.IsInRole("K_CRM_DIRETOR_GERAL")
    ehDiretorProduto = Thread.CurrentPrincipal.IsInRole("K_CRM_DIRETOR_PRODUTO")
    ehDiretorVendas = Thread.CurrentPrincipal.IsInRole("K_CRM_DIRETOR_VENDAS")
    ehGerenteCanais = Thread.CurrentPrincipal.IsInRole("K_CRM_GERENTE_CANAIS")
    ehAdmin = Thread.CurrentPrincipal.IsInRole("K_CRM_ADMIN") 
    ehGDQ = Thread.CurrentPrincipal.IsInRole("K_CRM_GDQ")
    
    ehDiretorRegional = Thread.CurrentPrincipal.IsInRole("K_CRM_DIRETOR_REGIONAL")
    ehGerenteRegional = Thread.CurrentPrincipal.IsInRole("K_CRM_GERENTE_REGIONAL")
    ehGerenteCanaisV2 = Thread.CurrentPrincipal.IsInRole("K_CRM_GERENTE_CANAIS_V2")
    
    ehExecutivo = Thread.CurrentPrincipal.IsInRole("K_EXECUTIVODECONTAS")
    ehGestorVertical = Thread.CurrentPrincipal.IsInRole("K_CRM_DIRETORVERTICAL")
    ehSDR = Thread.CurrentPrincipal.IsInRole("K_CRM_SDR_V2")
    #ehSDR = Thread.CurrentPrincipal.IsInRole("K_CRM_SDR")
    
    widget.Hidden = True;
    
#    if (ehSDR):
#        if Entity.GetFirstOrDefault(EntityDefinition.GetByName("FILIAIS"), Criteria("A.HANDLE = @FILIAL")) == None:
#            widget.Hidden = True
#        else:
#            filial = Entity.GetFirstOrDefault(EntityDefinition.GetByName("FILIAIS"), Criteria("A.HANDLE = @FILIAL"));  
#            if filial.Fields["K_EHREVENDA"] == True:
#                widget.Hidden = False;
#            else:
#                widget.Hidden = True
#    else:
#        widget.Hidden = True
        
#    if ehAdmin:
#        widget.View.Commands["cmdConsultarVerticais"].Visible = True;
</SourceCode>
    </ScriptItemPortable>
    <ScriptItemPortable>
      <FunctionName>InitializeRow</FunctionName>
      <LanguageName>IronPython</LanguageName>
      <SourceCode>def InitializeRow(entity, row):
    from System.Threading import Thread
    from Benner.Tecnologia.Common import BennerIdentity
    from Benner.Tecnologia.Wes.Components import MessageType
    from Benner.Tecnologia.Common import EntityBase
    from Benner.Tecnologia.Common import Entities
    from Benner.Tecnologia.Common import EntityDefinition
    from Benner.Tecnologia.Common import EntityState
    from Benner.Tecnologia.Common import Entity
    from Benner.Tecnologia.Common import Criteria
    from Benner.Tecnologia.Common import Parameter
    from Benner.Tecnologia.Common import GetMode
    
    ehAdmin = Thread.CurrentPrincipal.IsInRole("K_CRM_ADMIN")

    
    # ======= FASES ===========
    #   fase 1 = Suspecção, 
    #   fase 2 = Prospecção, 
    #   fase 3 = Negociação,  
    #   fase 4 = Cliente,
    #   fase 5 = Inativo,
    # ======= END FASES =======
    
    # ======= STATUS ===========
    #   status 1 = Não integrado, 
    #   status 2 = Integrado
    # ======= END FASES =======
    
    status = int(entity.Fields["INTEGRACAOEXACT"].Value);
    
    fase = int(entity.Fields["FASE"].Handle.Value)
    faseCor = entity.Fields["FASE"].Instance.Fields["COR"]
    faseLegenda = entity.Fields["FASE"].Instance.Fields["LEGENDAGRID"]
    faseNome = entity.Fields["FASE"].Instance.Fields["NOME"]
    faseFinal = ""
    subfase = int(entity.Fields["SUBFASE"].Handle.Value)
    subfaseNome = entity.Fields["SUBFASE"].Instance.Fields["NOME"]
    
    if entity.Fields["TIPO"] != None:
        tipo = int(entity.Fields["TIPO"].Value);
    
    if entity.Fields["SITUACAORECEITA"] != None:
        situacaoreceita = int(entity.Fields["SITUACAORECEITA"].Value);
    
    usuario = BennerIdentity.Current.UserHandle
    responsavel = entity.Fields["USUARIORESPONSAVEL"].Handle
    executivo = entity.Fields["USUARIOEXECUTIVO"].Handle
        
    if row.GetCustomCommand("cmdAtividadesPendentes") != None:
        row.GetCustomCommand("cmdAtividadesPendentes").Enabled = (faseNome != "Ex cliente" and faseNome != "Prospecção Futura") #(fase not in [11] );
        
    if entity.Fields["USUARIORESPONSAVEL"].Handle != usuario:
        if row.GetCustomCommand("cmdEdit") != None:
            row.GetCustomCommand("cmdEdit").Enabled = False;
    
    row.GetCellByName("FASE").Text = "&lt;span style='width:120px; height:25px; padding-top: 5px; display: inline-block; text-align: center;background-color:"+faseCor+"' class='label'&gt;"+faseLegenda +"&lt;/span&gt;"
    
    if entity.Fields["GRUPOEMPRESARIAL"].Handle.IsValid():
        row.GetCellByName("FASE").Text = "&lt;span style='margin-left:40%'&gt;-&lt;/span&gt;" 
        row.GetCellByName("SUBFASE").Text = "&lt;span style='margin-left:40%'&gt;-&lt;/span&gt;"   
        
    if entity.Fields["TIPO"] != None:    
        if tipo in [2]:
            i = 0
            while(row.Cells.Count &gt; i):
                row.GetCellByIndex(i).TextColor = "#95a5a6"
                i += 1
    
    if entity.Fields["SITUACAORECEITA"] != None:    
        if situacaoreceita in [2]:
            i = 0
            while(row.Cells.Count &gt; i):
                row.GetCellByIndex(i).TextColor = "#f03434"
                i += 1
    
    if entity.Fields["SUBFASE"].Handle.IsValid():
        if subfaseNome != "A qualificar":
            if row.GetCustomCommand("cmdQuestionario") != None:
                row.GetCustomCommand("cmdQuestionario").Enabled = False;
        elif subfaseNome == "A qualificar" and (entity.Fields["USUARIORESPONSAVEL"].Handle == usuario or entity.Fields["USUARIOEXECUTIVO"].Handle == usuario ):
            if row.GetCustomCommand("cmdQuestionario") != None:
                row.GetCustomCommand("cmdQuestionario").Enabled = True;
        else:
            if row.GetCustomCommand("cmdQuestionario") != None:
                row.GetCustomCommand("cmdQuestionario").Enabled = False;
    
    criteria = Criteria("A.PERMITIROPORTUNIDADE = 'S' AND A.HANDLE = :SUBFASE", Parameter("SUBFASE", subfase))
    aceitaOportunidade = Entity.GetFirstOrDefault(EntityDefinition.GetByName("K_CRM_SUBFASES"), criteria)
        
    if aceitaOportunidade != None:    
        if row.GetCustomCommand("cmdOportunidades") != None:
            row.GetCustomCommand("cmdOportunidades").Enabled = True;
    else:
        if row.GetCustomCommand("cmdOportunidades") != None:
            row.GetCustomCommand("cmdOportunidades").Enabled = False;
</SourceCode>
    </ScriptItemPortable>
  </Scripts>
</ScriptPortable>