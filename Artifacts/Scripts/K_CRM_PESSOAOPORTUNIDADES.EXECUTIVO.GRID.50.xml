<?xml version="1.0"?>
<ScriptPortable xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <ViewName>K_CRM_PESSOAOPORTUNIDADES.EXECUTIVO.GRID</ViewName>
  <EntityName>K_CRM_PESSOAOPORTUNIDADES</EntityName>
  <Level>Cliente</Level>
  <Scripts>
    <ScriptItemPortable>
      <FunctionName>Load</FunctionName>
      <LanguageName>IronPython</LanguageName>
      <SourceCode>def Load(widget):
    from System.Threading import Thread
    from Benner.Tecnologia.Common import BennerPrincipal
    
    activeRole = BennerPrincipal.Current.ActiveRole
    
    ehArquiteto = activeRole == "K_CRM_ARQUITETO_SOLUCOES" #Thread.CurrentPrincipal.IsInRole("K_CRM_ARQUITETO_SOLUCOES")
    ehGestorComercial = activeRole == "K_CRM_GESTOR_COMERCIAL" #Thread.CurrentPrincipal.IsInRole("K_CRM_GESTOR_COMERCIAL")
    ehGestorComercialRevenda = activeRole == "K_CRM_GESTOR_COMERCIAL_REVENDA" #Thread.CurrentPrincipal.IsInRole("K_CRM_GESTOR_COMERCIAL_REVENDA")
    ehGestorProduto = activeRole == "K_CRM_GESTOR_PRODUTO" #Thread.CurrentPrincipal.IsInRole("K_CRM_GESTOR_PRODUTO")
    ehPresidente = activeRole == "K_CRM_PRESIDENTE" #Thread.CurrentPrincipal.IsInRole("K_CRM_PRESIDENTE")
    ehVicePresidente = activeRole == "K_CRM_VP" #Thread.CurrentPrincipal.IsInRole("K_CRM_VP")
    ehDiretor = activeRole == "K_CRM_DIRETOR_GERAL" #Thread.CurrentPrincipal.IsInRole("K_CRM_DIRETOR_GERAL")
    ehDiretorProduto = activeRole == "K_CRM_DIRETOR_PRODUTO" #Thread.CurrentPrincipal.IsInRole("K_CRM_DIRETOR_PRODUTO")
    ehDiretorVendas = activeRole == "K_CRM_DIRETOR_VENDAS" #Thread.CurrentPrincipal.IsInRole("K_CRM_DIRETOR_VENDAS")
    ehGerenteCanais = activeRole == "K_CRM_GERENTE_CANAIS_V2" #Thread.CurrentPrincipal.IsInRole("K_CRM_GERENTE_CANAIS_V2")
    ehAdmin = activeRole == "K_CRM_ADMIN" #Thread.CurrentPrincipal.IsInRole("K_CRM_ADMIN")
    ehDiretorRegional = activeRole == "K_CRM_DIRETOR_REGIONAL" #Thread.CurrentPrincipal.IsInRole("K_CRM_DIRETOR_REGIONAL")
    ehGerenteRelacionamento = activeRole == "K_CRM_GERENTE_RELACIONAMENTO" #Thread.CurrentPrincipal.IsInRole("K_CRM_GERENTE_RELACIONAMENTO") 
    ehHeadVertical = activeRole == "K_CRM_DIRETORVERTICAL" #Thread.CurrentPrincipal.IsInRole("K_CRM_DIRETORVERTICAL")
    ehGerenteProdutos = activeRole == "K_CRM_GERENTE_PRODUTOS" #Thread.CurrentPrincipal.IsInRole("K_CRM_GERENTE_PRODUTOS") 
    ehAssistenteComercial = activeRole == "K_CRM_ASSISTENTE_COMERCIAL" #Thread.CurrentPrincipal.IsInRole("K_CRM_ASSISTENTE_COMERCIAL")
    
    if (ehArquiteto or ehGestorComercial or ehAssistenteComercial or ehGestorComercialRevenda or ehGestorProduto or ehPresidente or
        ehVicePresidente or ehDiretor or ehDiretorProduto or ehGerenteRelacionamento or ehGerenteProdutos or
        ehDiretorVendas or ehGerenteCanais or ehAdmin or ehDiretorRegional or ehHeadVertical):
        widget.Hidden = True
    else:
        widget.Hidden = False
</SourceCode>
    </ScriptItemPortable>
    <ScriptItemPortable>
      <FunctionName>InitializeRow</FunctionName>
      <LanguageName>IronPython</LanguageName>
      <SourceCode>def InitializeRow(entity, row):
    from System.Threading import Thread
    from Benner.Tecnologia.Common import BennerIdentity
    from Benner.Tecnologia.Common import EntityBase
    from Benner.Tecnologia.Common import EntityDefinition
    from Benner.Tecnologia.Common import Entity
    from Benner.Tecnologia.Common import Criteria
    from Benner.Tecnologia.Common import Parameter
    
    usuario = BennerIdentity.Current.UserHandle
    status  = int(entity.Fields["STATUS"].Value)
    statusoportunidade  = int(entity.Fields["STATUSOPORTUNIDADE"].Handle.Value)
    responsavel = entity.Fields["RESPONSAVEL"].Handle
    ehGestor = Thread.CurrentPrincipal.IsInRole("K_CRM_GESTOR_COMERCIAL")
    ehAdmin = Thread.CurrentPrincipal.IsInRole("K_CRM_ADMIN")
    modalidade  = int(entity.Fields["MODALIDADE"].Handle.IsValid())
    faseOportunidade = entity.Fields["STATUSOPORTUNIDADE"].Instance.Fields["NOME"];
    
    if entity.Fields["MANUAL"] == True:
        row.GetCustomCommand("cmdEditarOportunidade").Enabled = False;
    else:
        row.GetCustomCommand("cmdEditarOportunidadeManual").Enabled = False;

    if entity.Fields["HANDLE"].IsValid():
        oportunidade = entity.Fields["HANDLE"];
        versao = entity.Fields["VERSAO"];
        crit = Criteria("A.OPORTUNIDADE IN (:OPORTUNIDADE) AND A.VERSAO = :VERSAO AND A.TIPO=2");
        crit.Parameters.Add(Parameter("OPORTUNIDADE", oportunidade));
        crit.Parameters.Add(Parameter("VERSAO", versao));
        proposta = Entity.GetMany(EntityDefinition.GetByName("K_CRM_PO_PROPOSTA"), crit);
        if faseOportunidade == "Negociação" or faseOportunidade == "Pregão / Leilão" or faseOportunidade == "Habilitação / Adjudicação" or faseOportunidade == "Proposta":#statusoportunidade in [4,12,13,22]:
            if None != proposta:
                if proposta.Count &gt; 0:
                    row.GetCustomCommand("cmdSolicitarDesconto").Enabled = False;
        else:
            row.GetCustomCommand("cmdEditarOportunidade").Enabled = False;
            row.GetCustomCommand("cmdEditarOportunidadeManual").Enabled = False;
            row.GetCustomCommand("cmdSolicitarDesconto").Enabled = False;
                    
        if usuario != responsavel:
            row.GetCustomCommand("cmdEditarOportunidade").Enabled = False;
            row.GetCustomCommand("cmdEditarOportunidadeManual").Enabled = False;
            row.GetCustomCommand("cmdSolicitarDesconto").Enabled = False;
            
        crit2 = Criteria("A.OPORTUNIDADE = :OPORTUNIDADE AND A.VERSAO = :VERSAO AND A.NIVELAPROVACAO &gt;= 1 AND A.NIVELAPROVACAO &lt;= 5 AND A.DATAAPROVACAO &gt;= (SELECT MAX(DATAAPROVACAO) FROM K_CRM_PO_DESCONTOS AS D2 WHERE A.OPORTUNIDADE = D2.OPORTUNIDADE AND A.VERSAO = D2.VERSAO AND D2.NIVELAPROVACAO = 1)");
        crit2.Parameters.Add(Parameter("OPORTUNIDADE", oportunidade));
        crit2.Parameters.Add(Parameter("VERSAO", versao));
        descontos= Entity.GetMany(EntityDefinition.GetByName("K_CRM_PO_DESCONTOS"), crit2);
        
        #if descontos.Count &gt; 0:
        #    row.GetCustomCommand("cmdSolicitarDesconto").Enabled = False;
    
    if row.GetCustomCommand("cmdAlteraChance") != None:
        row.GetCustomCommand("cmdAlteraChance").Enabled = (ehGestor or (usuario == entity.Fields["RESPONSAVEL"].Handle and status not in [3,5,9,10]))
    if row.GetCustomCommand("cmdAlteraStatus") != None: 
        row.GetCustomCommand("cmdAlteraStatus").Enabled = (ehGestor or (usuario == entity.Fields["RESPONSAVEL"].Handle and status not in [3,5,9,10]))
    
    if entity.Fields["TEMPERATURA"] == None: return;
    
    temperatura = int(entity.Fields["TEMPERATURA"].Value)
    temperaturaNome = entity.Fields["TEMPERATURA"].Text
    
    if temperatura in [1]:
        row.GetCellByName("TEMPERATURA").Text = "&lt;span class='label bg-blue-madison col-sm-12' style='height:25px;text-align:center;padding-top:5px' &gt;"+temperaturaNome+"&lt;/span&gt;"
    if temperatura in [2]:
        row.GetCellByName("TEMPERATURA").Text = "&lt;span class='label bg-green-jungle col-sm-12' style='height:25px;text-align:center;padding-top:5px'&gt;"+temperaturaNome+"&lt;/span&gt;"
    if temperatura in [3,4]:
        row.GetCellByName("TEMPERATURA").Text = "&lt;span class='label bg-red-intense col-sm-12' style='height:25px;text-align:center;padding-top:5px'&gt;"+temperaturaNome+"&lt;/span&gt;"
        
    if entity.Ativo == True:
        row.GetCustomCommand("cmdEditarOportunidade").Enabled = False;
        row.GetCustomCommand("cmdEditarOportunidadeManual").Enabled = False;
</SourceCode>
    </ScriptItemPortable>
  </Scripts>
</ScriptPortable>