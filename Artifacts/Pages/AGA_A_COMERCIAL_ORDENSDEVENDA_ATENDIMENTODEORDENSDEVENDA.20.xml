<?xml version="1.0"?>
<PagePortable xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <Title>Atendimento de ordens de venda</Title>
  <Url>~/aga/a/comercial/ordensDeVenda/AtendimentoDeOrdensDeVenda.aspx</Url>
  <AutoGenerated>true</AutoGenerated>
  <EntityPermissionId />
  <TemplateId />
  <Details />
  <Id>AGA_A_COMERCIAL_ORDENSDEVENDA_ATENDIMENTODEORDENSDEVENDA</Id>
  <Level>Benner</Level>
  <CodeFile />
  <CodeInherits>Benner.Corporativo.Wes.WebApp.aga.a.comercial.atendimentoOrdensVenda.AtendimentoDeOrdensDeVenda</CodeInherits>
  <Widgets>
    <PageWidgetPortable>
      <Id>ATENDIMENTOORDENSDEVENDA</Id>
      <Title>Atendimento de ordens de venda</Title>
      <Order>10</Order>
      <ShowTitle>true</ShowTitle>
      <PortletCssClass />
      <FontIcon />
      <Subtitle />
      <ChromeState>Fixed</ChromeState>
      <PortletLayout>Default</PortletLayout>
      <WidgetTypeId>SimpleGrid</WidgetTypeId>
      <BootstrapCols>12</BootstrapCols>
      <XmlAttributes><![CDATA[<SimpleGridAttributes>
  <CanDelete>false</CanDelete>
  <CanUpdate>false</CanUpdate>
  <CanInsert>false</CanInsert>
  <EntityViewName>AGA_CM_ORDEMVENDAENTREGAS.GRID</EntityViewName>
  <DefaultFilterName>Filtro</DefaultFilterName>
  <Mode>3</Mode>
  <UserDefinedSelectColumnVisible>true</UserDefinedSelectColumnVisible>
  <UserDefinedPageSize>10</UserDefinedPageSize>
  <SystemFilterOnly>false</SystemFilterOnly>
  <DisplayRowCommand>true</DisplayRowCommand>
  <CompanyFilterMode>0</CompanyFilterMode>
  <UserDefinedCriteriaWhereClause>A.HANDLE IN (SELECT A.HANDLE FROM CM_ORDEMVENDAENTREGAS A
                                  LEFT JOIN CM_ORDEMVENDAITENS F ON A.ITEM = F.HANDLE
                                  LEFT JOIN CM_ORDENSVENDA B ON B.HANDLE = F.ORDEMVENDA
                                  LEFT JOIN PD_PRODUTOS C ON C.HANDLE = F.PRODUTO
                                  WHERE (C.TIPO = 1 OR C.TIPO = 2 OR C.TIPO = 5)
                                  AND C.ATIVO = 'S'
                                  AND (
                                        (
                                            (B.ENTREGAFUTURA = 'S') 
                                            AND (F.QUANTIDADEFATURADAENTFUT &gt; 0) 
                                            AND ( (SELECT COUNT(*) FROM CM_ORDEMVENDAENTREGAS WHERE CM_ORDEMVENDAENTREGAS.ITEM = F.HANDLE) = 1)
                                        )
                                        OR (B.ENTREGAFUTURA = 'N' OR B.ENTREGAFUTURA IS NULL)
                                      ) 
                                  AND F.STATUS &lt;&gt; 7 
                                  AND B.EMPRESA = @EMPRESA 
                                  AND B.FILIAL IN  @FILIAIS 
                                  AND B.STATUS IN (2, 3))</UserDefinedCriteriaWhereClause>
  <FormUrl>~/aga/a/comercial/ordensDeVenda/InformacoesOrdemDeVenda.aspx</FormUrl>
  <ShowExport>true</ShowExport>
  <UserDefinedDisableRowSelection>true</UserDefinedDisableRowSelection>
</SimpleGridAttributes>
]]></XmlAttributes>
      <Level>Benner</Level>
    </PageWidgetPortable>
    <PageWidgetPortable>
      <Id>LOTES</Id>
      <Title>Lotes</Title>
      <Order>20</Order>
      <ShowTitle>true</ShowTitle>
      <PortletCssClass />
      <FontIcon />
      <Subtitle />
      <ChromeState>Fixed</ChromeState>
      <PortletLayout>Default</PortletLayout>
      <WidgetTypeId>EditableGrid</WidgetTypeId>
      <BootstrapCols>12</BootstrapCols>
      <XmlAttributes><![CDATA[<AdvancedEditGridAttributes>
  <CanDelete>true</CanDelete>
  <CanUpdate>true</CanUpdate>
  <CanInsert>true</CanInsert>
  <EntityViewName>CM_ORDEMVENDAITEMLOTES.GRID</EntityViewName>
  <Mode>5</Mode>
  <UserDefinedSelectColumnVisible>false</UserDefinedSelectColumnVisible>
  <UserDefinedPageSize>10</UserDefinedPageSize>
  <SystemFilterOnly>false</SystemFilterOnly>
  <DisplayRowCommand>true</DisplayRowCommand>
  <CompanyFilterMode>1</CompanyFilterMode>
</AdvancedEditGridAttributes>]]></XmlAttributes>
      <Level>Benner</Level>
    </PageWidgetPortable>
  </Widgets>
  <Resources>
    <PageResourcePortable>
      <Id>A50691F8467C45E0B81A55AE333995EA</Id>
      <ResourceType>JavaScript</ResourceType>
      <Content><![CDATA[// Módulo para manipulação de filtros
const filtroModule = (() => {
    const ocultarFiltro = (fadeOut) => {
        if (fadeOut)
            $('#ctl00_Main_ATENDIMENTOORDENSDEVENDA_FilterControl_FilterContainer').fadeOut(500);
        else
            $('#ctl00_Main_ATENDIMENTOORDENSDEVENDA_FilterControl_FilterContainer').hide();
        
        $('#labelOcultarFiltroAtendimentoOrdensDeVenda').css('display', 'none');
        $('#labelExibirFiltroAtendimentoOrdensDeVenda').css('display', '');
        
        sessionStorage.setItem('TOGGLE_FILTRO_ATENDIMENTOORDENSDEVENDA', "Oculto");
    };

    const exibirFiltro = () => {
        $('#ctl00_Main_ATENDIMENTOORDENSDEVENDA_FilterControl_FilterContainer').fadeIn(500);
        $("#HasFilterApplied_AtendimentoOrdensDeVenda").val("False");
        
        $('#labelOcultarFiltroAtendimentoOrdensDeVenda').css('display', '');
        $('#labelExibirFiltroAtendimentoOrdensDeVenda').css('display', 'none');
        
        sessionStorage.setItem('TOGGLE_FILTRO_ATENDIMENTOORDENSDEVENDA', "Visivel");
    };

    const processarVisibilidadeFiltro = () => {
        const estadoFiltro = sessionStorage.getItem('TOGGLE_FILTRO_ATENDIMENTOORDENSDEVENDA');
        
        if (estadoFiltro === "Oculto" || $("#HasFilterApplied_AtendimentoOrdensDeVenda").val() == "True")
            ocultarFiltro();
    };
    
    // Função para alternar entre exibir e ocultar o filtro
    function toggleFiltro() {
        const filtroVisivel = $('#ctl00_Main_ATENDIMENTOORDENSDEVENDA_FilterControl_FilterContainer').is(':visible');
        
        if (filtroVisivel) {
            filtroModule.ocultarFiltro(true);
            $('#toggleFiltroButton').text('Exibir filtro');
        } else {
            filtroModule.exibirFiltro();
            $('#toggleFiltroButton').text('Ocultar filtro');
        }
    }

    return {
        toggleFiltro,
        ocultarFiltro,
        exibirFiltro,
        processarVisibilidadeFiltro
    };
})();

// Módulo para manipulação de grid de lotes
const gridLotesModule = (() => {
    const ocultarGridLotes = () => {
        $("#LOTES").hide();
        $("#VisibilidadeGridLotes").val("False");
    };

    const exibirGridLotes = () => {
        $("#LOTES").fadeIn();
        $("#VisibilidadeGridLotes").val("True");
    };

    const processarVisibilidadeGridLotes = () => {
        if ($("#VisibilidadeGridLotes").val() == "False")
            ocultarGridLotes();
        else
            exibirGridLotes();
    };

    return {
        ocultarGridLotes,
        exibirGridLotes,
        processarVisibilidadeGridLotes
    };
})();

// Módulo para inicialização de campos
const camposModule = (() => {
    const conversorDecimal = value => currency(value, { separator: '.', decimal: ',', precision: 4 });

    const inicializarLookup = (nomeCampo, infoCampo) => {
        new Vue({
            el: '#' + nomeCampo,
            mounted: function() { 
                if (infoCampo.Handle)
                    $('#' + nomeCampo + " select").append(new Option(infoCampo.Texto, infoCampo.Handle, true, true)); 
                
                $('#' + nomeCampo + " select").attr("disabled", infoCampo.ReadOnly); 
                $('#' + nomeCampo + " select").on("change", function () {
                    const jsonItens = JSON.parse($("#JsonDadosItens").val());
                    jsonItens[nomeCampo].Handle = Number(this.value);
                    jsonItens[nomeCampo].Texto = this.options[this.selectedIndex].text;
                    $("#JsonDadosItens").val(JSON.stringify(jsonItens));
                }); 
            }
        });
    };

    const inicializarCampos = () => {
        if (!$("#JsonDadosItens").val())
            return;
                
        $("#ATENDIMENTOORDENSDEVENDA tbody tr").each((index, linha) => {
            const handle = $(linha).attr("handle");
            
            if (!handle)
                return;
            
            const jsonItens = JSON.parse($("#JsonDadosItens").val());
            
            const campoAlmoxarifado = "ALMOXARIFADO_" + handle;
            const campoQuantidade = "QUANTIDADERESERVAR_" + handle;
            
            if ($('#' + campoAlmoxarifado + ' wes-lookup').length)
                inicializarLookup(campoAlmoxarifado, jsonItens[campoAlmoxarifado]);
            
            $('#' + campoQuantidade).on("blur", function() {
                const jsonItens = JSON.parse($("#JsonDadosItens").val());
                jsonItens[campoQuantidade].Quantidade = conversorDecimal($(this).val()).value;
                $("#JsonDadosItens").val(JSON.stringify(jsonItens));
            });
            
            $('#' + campoQuantidade).val(conversorDecimal(jsonItens[campoQuantidade].Quantidade).format());
            $('#' + campoQuantidade).attr("readonly", jsonItens[campoQuantidade].ReadOnly);
        });
    };

    return {
        inicializarCampos
    };
})();

// Módulo para manipulação de DOM
const domModule = (() => {
    const botoesControle = () => {
        $('#ctl00_Main_ATENDIMENTOORDENSDEVENDA_toolbar').append('<a class="btn custom-action command-action blue active" onclick="filtroModule.toggleFiltro();" id="toggleFiltroButton"> Exibir/Ocultar filtro </a>');
        
        $('#ctl00_Main_LOTES_toolbar').prepend('<div class="btn-group" data-toggle="buttons"><a id="top-OcultarLotes" class="btn command-action custom-action btn command-action yellow-lemon" style="" onclick="gridLotesModule.ocultarGridLotes()"><i class="fa fa-arrow-left btn-action"></i> Ocultar</a></div>');
    };

    return {
        botoesControle
    };
})();

// Inicialização
$(() => {
    const pagina = Sys.WebForms.PageRequestManager.getInstance();
    
    if (!pagina.get_isInAsyncPostBack()) {
        pagina.add_endRequest(filtroModule.processarVisibilidadeFiltro);
        pagina.add_endRequest(gridLotesModule.processarVisibilidadeGridLotes);
        pagina.add_endRequest(camposModule.inicializarCampos);
        pagina.add_endRequest(domModule.botoesControle);
    }
    
    filtroModule.processarVisibilidadeFiltro();
    gridLotesModule.processarVisibilidadeGridLotes();
    camposModule.inicializarCampos();
    domModule.botoesControle();
});
]]></Content>
      <Level>Benner</Level>
    </PageResourcePortable>
    <PageResourcePortable>
      <Id>0BFBDD362FC84B6EAC656B35B9F624CD</Id>
      <ResourceType>CSS</ResourceType>
      <Content><![CDATA[#ATENDIMENTOORDENSDEVENDA th, td, #LOTES th, td {
    white-space:nowrap !important;
}

#top-OcultarLotes {
    margin-right: 5px;
    float: left;
}

.customAlmoxarifado {
    min-width: 400px;
}

.customQuantidadeReservar {
    min-width: 160px;
}]]></Content>
      <Level>Benner</Level>
    </PageResourcePortable>
  </Resources>
</PagePortable>